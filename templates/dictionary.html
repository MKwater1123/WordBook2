{% extends "layout.html" %}
{% block title %}å˜èªå¸³ - VocabularyBook{% endblock %}

{% block content %}

<div class="flex items-center justify-between mb-4 flex-wrap gap-3">
    <h1 class="text-xl font-bold text-gray-800">ğŸ“š My Dictionary</h1>

    <!-- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³ç¾¤ -->
    <div id="normal-actions" class="flex gap-2 flex-wrap">
        <!-- é¸æŠãƒ¢ãƒ¼ãƒ‰ã¸ -->
        <button id="enter-select-btn" onclick="enterSelectionMode()"
            class="bg-blue-50 hover:bg-blue-100 text-blue-700 text-sm font-semibold px-4 py-2 rounded-lg border border-blue-200 transition">
            é¸æŠ
        </button>
        <!-- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
        <a href="{{ url_for('export', book=book) }}"
            class="bg-green-50 hover:bg-green-100 text-green-700 text-sm font-semibold px-4 py-2 rounded-lg border border-green-200 transition">
            â¬‡å…¨ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </a>
        <!-- ã‚¯ãƒªã‚¢ -->
        <form action="{{ url_for('clear') }}" method="POST"
            onsubmit="return confirm('{{ 'Reading' if book == 'reading' else 'Listening' }} å˜èªå¸³ã‚’å…¨ä»¶å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')">
            <input type="hidden" name="book" value="{{ book }}" />
            <button type="submit"
                class="bg-red-50 hover:bg-red-100 text-red-700 text-sm font-semibold px-4 py-2 rounded-lg border border-red-200 transition">
                å…¨ã¦å‰Šé™¤
            </button>
        </form>
        <!-- è¿½åŠ  -->
        <button onclick="openAddModal()"
            class="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-sm font-semibold px-4 py-2 rounded-lg border border-indigo-200 transition">
            ï¼‹ è¿½åŠ 
        </button>
    </div>
</div>

<!-- é¸æŠãƒ¢ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ (åˆæœŸéè¡¨ç¤º) -->
<div id="select-toolbar"
    class="hidden mb-4 flex items-center gap-3 flex-wrap bg-blue-50 border border-blue-200 rounded-xl px-4 py-3">
    <label class="flex items-center gap-1.5 cursor-pointer text-sm font-semibold text-blue-700">
        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this)"
            class="w-4 h-4 accent-blue-600" />
        å…¨ã¦é¸æŠ
    </label>
    <span id="select-count-badge" class="text-sm text-blue-600 font-medium">0 ä»¶é¸æŠä¸­</span>
    <div class="flex gap-2 ml-auto flex-wrap">
        <button id="export-selected-btn" disabled onclick="submitExportSelected()" class="text-sm font-semibold px-4 py-1.5 rounded-lg border transition
                   bg-green-50 text-green-700 border-green-200 hover:bg-green-100
                   disabled:opacity-40 disabled:cursor-not-allowed">
            â¬‡ é¸æŠè¡Œã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </button>
        <button id="delete-selected-btn" disabled onclick="submitDeleteSelected()" class="text-sm font-semibold px-4 py-1.5 rounded-lg border transition
                   bg-red-50 text-red-700 border-red-200 hover:bg-red-100
                   disabled:opacity-40 disabled:cursor-not-allowed">
            é¸æŠè¡Œã‚’å‰Šé™¤
        </button>
        <button onclick="exitSelectionMode()"
            class="text-sm font-semibold px-4 py-1.5 rounded-lg border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 transition">
            âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
    </div>
</div>

<!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% for category, message in messages %}
<div class="mb-4 px-4 py-3 rounded-lg text-sm font-medium
      {% if category == 'success' %}bg-blue-50 text-blue-800 border border-blue-200
      {% elif category == 'error' %}bg-red-50 text-red-800 border border-red-200
      {% else %}bg-amber-50 text-amber-800 border border-amber-200{% endif %}">
    {{ message }}
</div>
{% endfor %}
{% endwith %}

<!-- ã‚½ãƒ¼ãƒˆãƒªãƒ³ã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼: ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆã¨é€†é †ã§ãƒªãƒ³ã‚¯ç”Ÿæˆ -->
{% macro sort_link(label, key) %}
{% if sort == key %}
{% set next_order = 'desc' if order == 'asc' else 'asc' %}
<a href="{{ url_for('dictionary', sort=key, order=next_order, book=book, pos=pos) }}"
    class="{% if book == 'reading' %}text-indigo-700{% else %}text-sky-700{% endif %} font-semibold hover:underline">
    {{ label }}
    {% if order == 'asc' %}â†‘{% else %}â†“{% endif %}
</a>
{% else %}
<a href="{{ url_for('dictionary', sort=key, order='asc', book=book, pos=pos) }}"
    class="text-gray-600 hover:{% if book == 'reading' %}text-indigo-600{% else %}text-sky-600{% endif %} hover:underline">
    {{ label }}
</a>
{% endif %}
{% endmacro %}

<!-- Reading / Listening ã‚¿ãƒ– -->
<div class="flex gap-1 mb-5 border-b border-gray-200">
    <a href="{{ url_for('dictionary', book='reading', sort=sort, order=order) }}"
        class="px-5 py-2 text-sm font-semibold rounded-t-lg border border-b-0 transition
               {% if book == 'reading' %}bg-white border-gray-200 text-indigo-700{% else %}bg-gray-50 border-transparent text-gray-500 hover:text-gray-700{% endif %}">
        ğŸ“– Reading
    </a>
    <a href="{{ url_for('dictionary', book='listening', sort=sort, order=order) }}"
        class="px-5 py-2 text-sm font-semibold rounded-t-lg border border-b-0 transition
               {% if book == 'listening' %}bg-white border-gray-200 text-sky-700{% else %}bg-gray-50 border-transparent text-gray-500 hover:text-gray-700{% endif %}">
        ğŸ§ Listening
    </a>
</div>



{% if words %}
<div class="mb-3">
    <!-- çµã‚Šè¾¼ã¿å…¥åŠ›æ¬„ -->
    <input id="filter-input" type="text" placeholder="ãƒ¯ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿â€¦" class="w-full max-w-xs border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2
               {% if book == 'reading' %}focus:ring-indigo-400{% else %}focus:ring-sky-400{% endif %}" />
    <!-- å“è©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    {% if pos_list %}
    <select id="pos-filter"
        class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2
               {% if book == 'reading' %}focus:ring-indigo-400{% else %}focus:ring-sky-400{% endif %} bg-white text-gray-700">
        <option value="{{ url_for('dictionary', book=book, sort=sort, order=order, pos='') }}" {% if not pos
            %}selected{% endif %}>ã™ã¹ã¦</option>
        {% for p in pos_list %}
        <option value="{{ url_for('dictionary', book=book, sort=sort, order=order, pos=p) }}" {% if pos==p %}selected{%
            endif %}>{{ p }}</option>
        {% endfor %}
    </select>
    {% endif %}
</div>

<!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
<div class="overflow-auto max-h-[65vh] border border-gray-200 rounded-xl shadow-sm">
    <table class="w-full text-sm text-left">
        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0 z-10">
            <tr>
                <th class="select-col hidden px-3 py-3 w-10"></th>
                <th class="px-4 py-3 whitespace-nowrap">{{ sort_link('å˜èª', 'word') }}</th>
                <th class="px-4 py-3 whitespace-nowrap">å“è©</th>
                <th class="px-4 py-3">æ„å‘³</th>
                <th class="px-4 py-3">ãƒ•ãƒ¬ãƒ¼ã‚º</th>
                <th class="px-4 py-3">ãƒ•ãƒ¬ãƒ¼ã‚ºã®æ„å‘³</th>
                <th class="px-4 py-3 whitespace-nowrap">ãã®ä»–</th>
                <th class="px-4 py-3 w-12"></th>
            </tr>
        </thead>
        <tbody id="word-table-body">
            {% for word in words %}
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition word-row" data-word-id="{{ word.id }}"
                data-word="{{ word.word | e }}" data-meaning="{{ word.meaning | e }}"
                data-pos="{{ word.part_of_speech | e }}" data-example="{{ word.example | e }}"
                data-example-ja="{{ word.example_ja | e }}" data-transitivity="{{ word.transitivity or '' }}"
                data-countability="{{ word.countability or '' }}" data-book="{{ word.book }}" style="">
                <td class="select-col hidden px-3 py-3 text-center">
                    <input type="checkbox" class="row-checkbox w-4 h-4 accent-blue-600 cursor-pointer"
                        data-word-id="{{ word.id }}" onchange="onRowCheckChange(this)" />
                </td>
                <td
                    class="px-4 py-3 font-semibold {% if book == 'reading' %}text-indigo-700{% else %}text-sky-700{% endif %} word-cell">
                    <div class="flex items-center gap-1.5">
                        <button type="button" onclick="speakText('{{ word.word | e }}', 'en')"
                            class="inline-flex items-center justify-center w-5 h-5 flex-shrink-0 rounded bg-gray-100 text-gray-400 hover:bg-indigo-100 hover:text-indigo-500 transition text-[10px]"
                            title="å˜èªã‚’èª­ã¿ä¸Šã’">â–¶</button>
                        {{ word.word }}
                    </div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <span
                        class="{% if word.part_of_speech == 'ç†Ÿèª' %}bg-amber-100 text-amber-700{% elif book == 'reading' %}bg-indigo-100 text-indigo-700{% else %}bg-sky-100 text-sky-700{% endif %} text-xs font-semibold px-2 py-0.5 rounded-full">
                        {{ word.part_of_speech }}
                    </span>
                </td>
                <td class="px-4 py-3 text-gray-700">{{ word.meaning }}</td>
                <td class="px-4 py-3 text-gray-500 italic">
                    <div class="flex items-center gap-1.5">
                        <button type="button" onclick="speakText('{{ word.example | e }}', 'en')"
                            class="inline-flex items-center justify-center w-5 h-5 flex-shrink-0 rounded bg-gray-100 text-gray-400 hover:bg-indigo-100 hover:text-indigo-500 transition text-[10px]"
                            title="ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’èª­ã¿ä¸Šã’">â–¶</button>
                        {{ word.example }}
                    </div>
                </td>
                <td class="px-4 py-3 text-gray-500">{{ word.example_ja }}</td>
                <td class="px-4 py-3 whitespace-nowrap">
                    {% if word.transitivity %}
                    <span class="bg-green-100 text-green-700 text-xs font-semibold px-2 py-0.5 rounded-full">
                        {{ word.transitivity }}
                    </span>
                    {% endif %}
                    {% if word.countability %}
                    <span class="bg-purple-100 text-purple-700 text-xs font-semibold px-2 py-0.5 rounded-full">
                        {{ word.countability }}
                    </span>
                    {% endif %}
                    {% if not word.transitivity and not word.countability %}
                    <span class="text-gray-300">â€”</span>
                    {% endif %}
                </td>
                <td class="px-3 py-3 text-center">
                    <button type="button" onclick="openEditModal(this.closest('.word-row'))"
                        class="text-xs text-gray-400 hover:text-indigo-600 border border-gray-200 hover:border-indigo-300 rounded px-2 py-1 transition"
                        title="ç·¨é›†">
                        âœï¸
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<p class="text-xs text-gray-400 mt-2 text-right">è¨ˆ {{ words | length }} ä»¶</p>

{% else %}
<p class="text-gray-400 text-sm text-center mt-16">
    {% if pos %}
    ã€Œ{{ pos }}ã€ã«è©²å½“ã™ã‚‹å˜èªã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
    {% else %}
    {% if book == 'reading' %}ğŸ“– Reading{% else %}ğŸ§ Listening{% endif %} å˜èªå¸³ã¯ã¾ã ç©ºã§ã™ã€‚æ¤œç´¢ãƒšãƒ¼ã‚¸ã‹ã‚‰å˜èªã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
    {% endif %}
</p>
{% endif %}

<!-- =====================================================================
     è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
     ===================================================================== -->
<div id="add-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeAddModal()"></div>
    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 p-6 z-10">
        <h2 class="text-base font-bold text-gray-800 mb-4">ï¼‹ å˜èªã‚’è¿½åŠ </h2>
        <form method="POST" action="{{ url_for('dictionary_add') }}">
            <input type="hidden" name="book" value="{{ book }}" />
            <div class="grid grid-cols-2 gap-3">
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">å˜èª <span
                            class="text-red-500">*</span></label>
                    <input type="text" name="word" required placeholder="ä¾‹: serendipity"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">å“è©</label>
                    <select id="add-pos" name="part_of_speech" onchange="updateConditionalFields('add')"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white text-gray-700">
                        <option value="åè©">åè©</option>
                        <option value="å‹•è©">å‹•è©</option>
                        <option value="å½¢å®¹è©">å½¢å®¹è©</option>
                        <option value="å‰¯è©">å‰¯è©</option>
                        <option value="ç†Ÿèª">ç†Ÿèª</option>
                        <option value="å‰ç½®è©">å‰ç½®è©</option>
                        <option value="æ¥ç¶šè©">æ¥ç¶šè©</option>
                        <option value="ä»£åè©">ä»£åè©</option>
                        <option value="åŠ©å‹•è©">åŠ©å‹•è©</option>
                        <option value="æ„Ÿå˜†è©">æ„Ÿå˜†è©</option>
                    </select>
                </div>
                <div id="add-transitivity-row" class="col-span-2 hidden">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">è‡ªå‹•è© / ä»–å‹•è©</label>
                    <select id="add-transitivity" name="transitivity"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white text-gray-700">
                        <option value="ä»–å‹•è©">ä»–å‹•è©</option>
                        <option value="è‡ªå‹•è©">è‡ªå‹•è©</option>
                        <option value="ä»–å‹•è©ãƒ»è‡ªå‹•è©">ä»–å‹•è©ãƒ»è‡ªå‹•è©</option>
                    </select>
                </div>
                <div id="add-countability-row" class="col-span-2 hidden">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">å¯ç®— / ä¸å¯ç®—</label>
                    <select id="add-countability" name="countability"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white text-gray-700">
                        <option value="å¯ç®—">å¯ç®—</option>
                        <option value="ä¸å¯ç®—">ä¸å¯ç®—</option>
                        <option value="å¯ç®—ãƒ»ä¸å¯ç®—">å¯ç®—ãƒ»ä¸å¯ç®—</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">å˜èªã®æ„å‘³</label>
                    <input type="text" name="meaning" placeholder="ä¾‹: æ€ã„ãŒã‘ãªã„å¹¸é‹"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">ãƒ•ãƒ¬ãƒ¼ã‚º</label>
                    <input type="text" name="example" placeholder="ä¾‹: Finding that cafÃ© was pure serendipity."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">ãƒ•ãƒ¬ãƒ¼ã‚ºã®æ„å‘³</label>
                    <input type="text" name="example_ja" placeholder="ä¾‹: ã‚ã®ã‚«ãƒ•ã‚§ã‚’è¦‹ã¤ã‘ãŸã®ã¯å…¨ãã®å¶ç„¶ã ã£ãŸã€‚"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-5">
                <button type="button" onclick="closeAddModal()"
                    class="px-4 py-2 text-sm rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit"
                    class="px-4 py-2 text-sm font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white transition">è¿½åŠ </button>
            </div>
        </form>
    </div>
</div>

<!-- =====================================================================
     ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
     ===================================================================== -->
<div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeEditModal()"></div>
    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 p-6 z-10">
        <h2 class="text-base font-bold text-gray-800 mb-4">âœï¸ å˜èªã‚’ç·¨é›†</h2>
        <form id="edit-form" method="POST" action="">
            <input type="hidden" name="book" value="{{ book }}" />
            <div class="grid grid-cols-2 gap-3">
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">å˜èª <span
                            class="text-red-500">*</span></label>
                    <input id="edit-word" type="text" name="word" required
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">å“è©</label>
                    <select id="edit-pos" name="part_of_speech" onchange="updateConditionalFields('edit')"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white text-gray-700">
                        <option value="åè©">åè©</option>
                        <option value="å‹•è©">å‹•è©</option>
                        <option value="å½¢å®¹è©">å½¢å®¹è©</option>
                        <option value="å‰¯è©">å‰¯è©</option>
                        <option value="ç†Ÿèª">ç†Ÿèª</option>
                        <option value="å‰ç½®è©">å‰ç½®è©</option>
                        <option value="æ¥ç¶šè©">æ¥ç¶šè©</option>
                        <option value="ä»£åè©">ä»£åè©</option>
                        <option value="åŠ©å‹•è©">åŠ©å‹•è©</option>
                        <option value="æ„Ÿå˜†è©">æ„Ÿå˜†è©</option>
                    </select>
                </div>
                <div id="edit-transitivity-row" class="col-span-2 hidden">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">è‡ªå‹•è© / ä»–å‹•è©</label>
                    <select id="edit-transitivity" name="transitivity"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white text-gray-700">
                        <option value="ä»–å‹•è©">ä»–å‹•è©</option>
                        <option value="è‡ªå‹•è©">è‡ªå‹•è©</option>
                        <option value="ä»–å‹•è©ãƒ»è‡ªå‹•è©">ä»–å‹•è©ãƒ»è‡ªå‹•è©</option>
                    </select>
                </div>
                <div id="edit-countability-row" class="col-span-2 hidden">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">å¯ç®— / ä¸å¯ç®—</label>
                    <select id="edit-countability" name="countability"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white text-gray-700">
                        <option value="å¯ç®—">å¯ç®—</option>
                        <option value="ä¸å¯ç®—">ä¸å¯ç®—</option>
                        <option value="å¯ç®—ãƒ»ä¸å¯ç®—">å¯ç®—ãƒ»ä¸å¯ç®—</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">å˜èªã®æ„å‘³</label>
                    <input id="edit-meaning" type="text" name="meaning"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">ãƒ•ãƒ¬ãƒ¼ã‚º</label>
                    <input id="edit-example" type="text" name="example"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">ãƒ•ãƒ¬ãƒ¼ã‚ºã®æ„å‘³</label>
                    <input id="edit-example-ja" type="text" name="example_ja"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-5">
                <button type="button" onclick="closeEditModal()"
                    class="px-4 py-2 text-sm rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit"
                    class="px-4 py-2 text-sm font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white transition">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰çµã‚Šè¾¼ã¿
    const filterInput = document.getElementById("filter-input");
    if (filterInput) {
        filterInput.addEventListener("input", function () {
            const query = this.value.toLowerCase();
            document.querySelectorAll(".word-row").forEach(function (row) {
                const word = row.querySelector(".word-cell").textContent.toLowerCase();
                row.style.display = word.includes(query) ? "" : "none";
            });
        });
    }
    // å“è©ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
    const posFilter = document.getElementById("pos-filter");
    if (posFilter) {
        posFilter.addEventListener("change", function () {
            window.location.href = this.value;
        });
    }

    // =========================================================
    // é¸æŠãƒ¢ãƒ¼ãƒ‰
    // =========================================================
    const BOOK = "{{ book }}";

    function enterSelectionMode() {
        document.getElementById("select-toolbar").classList.remove("hidden");
        document.getElementById("enter-select-btn").classList.add("hidden");
        document.querySelectorAll(".select-col").forEach(el => el.classList.remove("hidden"));
        updateSelectCount();
    }

    function exitSelectionMode() {
        // ãƒã‚§ãƒƒã‚¯ã‚’å…¨è§£é™¤
        document.querySelectorAll(".row-checkbox").forEach(cb => {
            cb.checked = false;
            const row = cb.closest(".word-row");
            if (row) highlightRow(row, false);
        });
        const allCb = document.getElementById("select-all-checkbox");
        if (allCb) allCb.checked = false;

        document.getElementById("select-toolbar").classList.add("hidden");
        document.getElementById("enter-select-btn").classList.remove("hidden");
        document.querySelectorAll(".select-col").forEach(el => el.classList.add("hidden"));
        updateSelectCount();
    }

    function highlightRow(row, checked) {
        if (checked) {
            row.style.backgroundColor = "#bae6fd"; // sky-200 ç›¸å½“
        } else {
            row.style.backgroundColor = "";
        }
    }

    function toggleSelectAll(checkbox) {
        const rows = document.querySelectorAll(".word-row");
        rows.forEach(row => {
            // éè¡¨ç¤ºè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
            if (row.style.display === "none") return;
            const cb = row.querySelector(".row-checkbox");
            if (cb) {
                cb.checked = checkbox.checked;
                highlightRow(row, checkbox.checked);
            }
        });
        updateSelectCount();
    }

    function onRowCheckChange(cb) {
        const row = cb.closest(".word-row");
        if (row) highlightRow(row, cb.checked);
        const allCb = document.getElementById("select-all-checkbox");
        const visible = Array.from(document.querySelectorAll(".word-row"))
            .filter(r => r.style.display !== "none");
        const allChecked = visible.length > 0 && visible.every(r => r.querySelector(".row-checkbox")?.checked);
        if (allCb) allCb.checked = allChecked;
        updateSelectCount();
    }

    function getSelectedIds() {
        return Array.from(document.querySelectorAll(".row-checkbox:checked"))
            .map(cb => cb.dataset.wordId);
    }

    function updateSelectCount() {
        const ids = getSelectedIds();
        const count = ids.length;
        const badge = document.getElementById("select-count-badge");
        if (badge) badge.textContent = `${count} ä»¶é¸æŠä¸­`;
        const exportBtn = document.getElementById("export-selected-btn");
        const deleteBtn = document.getElementById("delete-selected-btn");
        if (exportBtn) exportBtn.disabled = count === 0;
        if (deleteBtn) deleteBtn.disabled = count === 0;
    }

    function buildIdsForm(action, ids) {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = action;
        form.style.display = "none";

        const bookInput = document.createElement("input");
        bookInput.type = "hidden";
        bookInput.name = "book";
        bookInput.value = BOOK;
        form.appendChild(bookInput);

        ids.forEach(id => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "ids[]";
            input.value = id;
            form.appendChild(input);
        });
        return form;
    }

    function submitExportSelected() {
        const ids = getSelectedIds();
        if (ids.length === 0) return;
        const form = buildIdsForm("{{ url_for('export_selected') }}", ids);
        document.body.appendChild(form);
        form.submit();
    }

    function submitDeleteSelected() {
        const ids = getSelectedIds();
        if (ids.length === 0) return;
        if (!confirm(`é¸æŠã—ãŸ ${ids.length} ä»¶ã®å˜èªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;
        const form = buildIdsForm("{{ url_for('delete_selected') }}", ids);
        document.body.appendChild(form);
        form.submit();
    }

    // =========================================================
    // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
    // =========================================================
    function openAddModal() {
        document.getElementById("add-modal").classList.remove("hidden");
        document.body.style.overflow = "hidden";
    }
    function closeAddModal() {
        document.getElementById("add-modal").classList.add("hidden");
        document.body.style.overflow = "";
    }

    // =========================================================
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
    // =========================================================
    // =========================================================
    // å“è©é€£å‹•: å¯ç®—/ä¸å¯ç®—ãƒ»è‡ªå‹•è©/ä»–å‹•è©ã®æ¡ä»¶ä»˜ãè¡¨ç¤º
    // =========================================================
    function updateConditionalFields(prefix) {
        const pos = document.getElementById(prefix + "-pos").value;
        const transitivityRow = document.getElementById(prefix + "-transitivity-row");
        const countabilityRow = document.getElementById(prefix + "-countability-row");
        if (pos === "å‹•è©") {
            transitivityRow.classList.remove("hidden");
            countabilityRow.classList.add("hidden");
            document.getElementById(prefix + "-countability").value = "";
        } else if (pos === "åè©") {
            countabilityRow.classList.remove("hidden");
            transitivityRow.classList.add("hidden");
            document.getElementById(prefix + "-transitivity").value = "";
        } else {
            transitivityRow.classList.add("hidden");
            countabilityRow.classList.add("hidden");
            document.getElementById(prefix + "-transitivity").value = "";
            document.getElementById(prefix + "-countability").value = "";
        }
    }

    function openEditModal(row) {
        const id = row.dataset.wordId;
        const form = document.getElementById("edit-form");
        form.action = `/dictionary/word/${id}/edit`;

        document.getElementById("edit-word").value = row.dataset.word || "";
        document.getElementById("edit-meaning").value = row.dataset.meaning || "";
        document.getElementById("edit-example").value = row.dataset.example || "";
        document.getElementById("edit-example-ja").value = row.dataset.exampleJa || "";

        // å“è©ã‚’ã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰æ¡ä»¶ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°
        document.getElementById("edit-pos").value = row.dataset.pos || "";
        updateConditionalFields("edit");
        document.getElementById("edit-transitivity").value = row.dataset.transitivity || "";
        document.getElementById("edit-countability").value = row.dataset.countability || "";

        document.getElementById("edit-modal").classList.remove("hidden");
        document.body.style.overflow = "hidden";
    }
    function closeEditModal() {
        document.getElementById("edit-modal").classList.add("hidden");
        document.body.style.overflow = "";
    }

    // Escã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
            closeAddModal();
            closeEditModal();
        }
    });
</script>
{% endblock %}